version: '3.8'

services:
  # Nginx load balancer
  nginx:
    image: nginx:alpine
    container_name: nodejs-nginx
    ports:
      - "${NGINX_PORT:-3000}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - nodejs-app
    networks:
      - nodejs-network
    restart: unless-stopped

  # Node.js + React SSR application
  # Strategy 1: Equal CPU division across replicas
  # Default: 4 replicas Ã— 2 cores = 8 cores total (adjust REPLICAS for your CPU count)
  nodejs-app:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # SSR modes: traditional, worker
      - SSR_MODE=${SSR_MODE:-traditional}
      - HOST=0.0.0.0
      - PORT=3000
      # Internal API URL: containers call their own APIs directly (bypass nginx)
      - INTERNAL_API_URL=http://localhost:3000
      # Docker deployment info for benchmarks
      - DOCKER=true
      - REPLICAS=${REPLICAS:-4}
      # Worker threads: Auto-detects from CPU quota, or override manually
      # With 4 replicas and 2 CPUs each: WORKER_THREADS=2 per container = 8 total workers
      - WORKER_THREADS=${WORKER_THREADS:-}
    networks:
      - nodejs-network
    deploy:
      # Number of replicas based on your CPU cores
      # For 16 cores: 4 replicas (each gets 4 cores)
      # For 8 cores:  2 replicas (each gets 4 cores)
      # Formula: REPLICAS = CPU_CORES / 4
      replicas: ${REPLICAS:-4}

      resources:
        limits:
          # No CPU limits - allow containers to burst and use 100% of available CPU
          # Kernel scheduler will balance load across all replicas
          memory: ${MEMORY_LIMIT:-512M}
        reservations:
          # Minimum guaranteed resources per replica
          cpus: '${CPU_RESERVATION:-2.0}'
          memory: ${MEMORY_RESERVATION:-256M}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/server-info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  nodejs-network:
    driver: bridge
